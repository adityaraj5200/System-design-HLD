# URL Shortener - Architecture Diagrams

## 1. System Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              URL Shortener System                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            ┌───────▼──────┐ ┌──────▼──────┐ ┌─────▼──────┐
            │   Frontend   │ │   Mobile    │ │   API      │
            │   (Web)      │ │   App       │ │   Clients  │
            └──────────────┘ └─────────────┘ └────────────┘
                    │               │               │
                    └───────────────┼───────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │        Load Balancer          │
                    │      (NGINX/HAProxy)         │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │        API Gateway            │
                    │   (Auth, Rate Limiting)      │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │      Service Layer            │
                    └───────────────┬───────────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
    ┌───────▼──────┐       ┌───────▼──────┐       ┌───────▼──────┐
    │   URL        │       │   User      │       │   Analytics  │
    │   Service    │       │   Service   │       │   Service    │
    └──────┬───────┘       └──────┬───────┘       └──────┬───────┘
           │                      │                      │
           └──────────────────────┼──────────────────────┘
                                  │
                    ┌─────────────▼─────────────┐
                    │      Cache Layer          │
                    │        (Redis)            │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────▼─────────────┐
                    │      Message Queue        │
                    │    (RabbitMQ/Kafka)      │
                    └─────────────┬─────────────┘
                                  │
                    ┌─────────────▼─────────────┐
                    │      Database Layer       │
                    │     (PostgreSQL)         │
                    └───────────────────────────┘
```

## 2. Data Flow Diagram

### URL Creation Flow
```
User → Frontend → API Gateway → URL Service → Cache → Database
  ↑                                                      │
  └────────────────── Response ←─────────────────────────┘
```

### URL Redirection Flow
```
User → Load Balancer → API Gateway → URL Service → Cache → Database
  ↑                                                      │
  └────────── Redirect Response ←─────────────────────────┘
```

### Analytics Flow
```
Click Event → URL Service → Message Queue → Analytics Service → Database
```

## 3. Component Interaction Sequence

### URL Creation Sequence
```
┌─────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  User   │ │   Frontend  │ │ API Gateway │ │URL Service  │ │ PostgreSQL  │
└────┬────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
     │             │                │               │               │
     │ Create URL  │                │               │               │
     │ ──────────▶ │                │               │               │
     │             │ POST /api/urls │               │               │
     │             │ ──────────────▶│               │               │
     │             │                │ Validate Auth │               │
     │             │                │ ─────────────▶│               │
     │             │                │               │ Generate Code │
     │             │                │               │ ─────────────▶│
     │             │                │               │               │ Store URL
     │             │                │               │               │ ────────▶│
     │             │                │               │               │ Success  │
     │             │                │               │               │ ◀───────│
     │             │                │               │ Response     │
     │             │                │               │ ◀────────────│
     │             │ Response       │               │
     │             │ ◀─────────────│               │
     │ Success     │                │               │
     │ ◀──────────│                │               │
```

### URL Redirection Sequence
```
┌─────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  User   │ │ Load Bal.   │ │ API Gateway │ │URL Service  │ │ PostgreSQL  │
└────┬────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
     │             │                │               │               │
     │ GET /abc123 │                │               │               │
     │ ──────────▶ │                │               │               │
     │             │ Route Request  │               │               │
     │             │ ──────────────▶│               │               │
     │             │                │ Check Cache   │               │
     │             │                │ ─────────────▶│               │
     │             │                │               │ Cache Miss   │
     │             │                │               │ ─────────────▶│
     │             │                │               │               │ Query DB
     │             │                │               │               │ ────────▶│
     │             │                │               │               │ URL Data │
     │             │                │               │               │ ◀───────│
     │             │                │               │ Update Cache │
     │             │                │               │ ─────────────▶│
     │             │                │ Response     │
     │             │                │ ◀────────────│
     │             │ Redirect       │               │
     │             │ ◀─────────────│               │
     │ Redirect    │                │               │
     │ ◀──────────│                │               │
```

## 4. Deployment Architecture

### Low-Scale Deployment (Single Server)
```
┌─────────────────────────────────────────────────────────┐
│                    Single Server                        │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   NGINX     │  │ Spring Boot │  │ PostgreSQL │    │
│  │ (Static +   │  │  (Monolith) │  │   (Local)  │    │
│  │  Reverse    │  │             │  │             │    │
│  │  Proxy)     │  │             │  │             │    │
│  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────┘
```

### High-Scale Deployment (Multi-Region)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Global Load Balancer                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            ┌───────▼──────┐ ┌──────▼──────┐ ┌─────▼──────┐
            │   US-East    │ │   US-West   │ │   Europe   │
            │   Region     │ │   Region    │ │   Region   │
            └──────┬───────┘ └──────┬──────┘ └──────┬─────┘
                   │                │               │
            ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐
            │ Load Bal.   │ │ Load Bal.   │ │ Load Bal.   │
            └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
                   │                │               │
            ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐
            │ API Gateway │ │ API Gateway │ │ API Gateway │
            └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
                   │                │               │
            ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐
            │ Services    │ │ Services    │ │ Services    │
            │ (Multiple   │ │ (Multiple   │ │ (Multiple   │
            │  Instances) │ │  Instances) │ │  Instances) │
            └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
                   │                │               │
            ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐
            │   Cache     │ │   Cache     │ │   Cache     │
            │  (Redis)    │ │  (Redis)    │ │  (Redis)    │
            └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
                   │                │               │
            ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐
            │ PostgreSQL  │ │ PostgreSQL  │ │ PostgreSQL  │
            │ (Sharded)   │ │ (Sharded)   │ │ (Sharded)   │
            └─────────────┘ └─────────────┘ └─────────────┘
```

## 5. Database Sharding Strategy

### User-Based Sharding
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Shard Router                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            ┌───────▼──────┐ ┌──────▼──────┐ ┌─────▼──────┐
            │   Shard 1    │ │   Shard 2   │ │   Shard 3  │
            │ (User ID     │ │ (User ID    │ │ (User ID   │
            │  0-33%)      │ │  34-66%)    │ │  67-100%)  │
            └──────────────┘ └─────────────┘ └────────────┘
```

### Shard Distribution Logic
```python
def get_shard(user_id):
    hash_value = hash(user_id) % 100
    if hash_value < 34:
        return "shard_1"
    elif hash_value < 67:
        return "shard_2"
    else:
        return "shard_3"
```

## 6. Caching Strategy

### Multi-Level Caching
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Client Browser                                │
│                           (L1 Cache - Local)                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │            CDN                │
                    │      (L2 Cache - Global)     │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │        Load Balancer          │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │        API Gateway            │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────▼──────────────┐
                    │      Service Layer            │
                    │   (L3 Cache - Application)   │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────▼──────────────┐
                    │        Redis Cache            │
                    │      (L4 Cache - Shared)     │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────▼──────────────┐
                    │        Database               │
                    │      (L5 Cache - Disk)       │
                    └───────────────────────────────┘
```

### Cache Invalidation Strategy
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Cache Invalidation                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            ┌───────▼──────┐ ┌──────▼──────┐ ┌─────▼──────┐
            │   TTL-based  │ │ Event-driven│ │ Pattern-   │
            │   Expiration │ │ Invalidation│ │ based      │
            │              │ │             │ │ Invalidation│
            └──────────────┘ └─────────────┘ └────────────┘
```

## 7. Security Architecture

### Authentication Flow
```
┌─────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  User   │ │   Frontend  │ │ API Gateway │ │User Service │ │ PostgreSQL  │
└────┬────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
     │             │                │               │               │
     │ Login       │                │               │               │
     │ ──────────▶ │                │               │               │
     │             │ POST /auth     │               │               │
     │             │ ──────────────▶│               │               │
     │             │                │ Validate      │               │
     │             │                │ Credentials   │               │
     │             │                │ ─────────────▶│               │
     │             │                │               │ Query User    │
     │             │                │               │ ─────────────▶│
     │             │                │               │               │ Verify Hash
     │             │                │               │               │ ────────▶│
     │             │                │               │               │ Success  │
     │             │                │               │               │ ◀───────│
     │             │                │ Generate JWT  │               │
     │             │                │ ◀────────────│               │
     │             │ JWT Token      │               │
     │             │ ◀─────────────│               │
     │ Success     │                │               │
     │ ◀──────────│                │               │
```

### Rate Limiting Architecture
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Rate Limiting                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            ┌───────▼──────┐ ┌──────▼──────┐ ┌─────▼──────┐
            │   Anonymous  │ │Authenticated│ │  Premium   │
            │   10/min     │ │  100/min    │ │ 1000/min   │
            └──────────────┘ └─────────────┘ └────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │        Redis Counter          │
                    │      (Sliding Window)        │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │        Rate Limiter           │
                    │      (Token Bucket)          │
                    └───────────────────────────────┘
```

## 8. Monitoring and Observability

### Metrics Collection
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Metrics Pipeline                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            ┌───────▼──────┐ ┌──────▼──────┐ ┌─────▼──────┐
            │ Application  │ │  System     │ │  Business  │
            │   Metrics    │ │  Metrics    │ │  Metrics   │
            │              │ │             │ │             │
            └──────┬───────┘ └──────┬──────┘ └──────┬─────┘
                   │                │               │
            ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐
            │   Prometheus │ │   Node     │ │   Custom    │
            │   Exporter   │ │  Exporter  │ │  Exporter   │
            └──────┬───────┘ └──────┬──────┘ └──────┬─────┘
                   │                │               │
                   └────────────────┼───────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │        Prometheus             │
                    │      (Time Series DB)        │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │        Grafana                │
                    │      (Visualization)         │
                    └───────────────────────────────┘
```

### Logging Architecture
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Logging Pipeline                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
            ┌───────▼──────┐ ┌──────▼──────┐ ┌─────▼──────┐
            │ Application  │ │   System    │ │  Access    │
            │     Logs     │ │    Logs     │ │   Logs     │
            │              │ │             │ │             │
            └──────┬───────┘ └──────┬──────┘ └──────┬─────┘
                   │                │               │
            ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐
            │   Fluentd   │ │   Fluentd   │ │   Fluentd   │
            │   (App)     │ │   (System)  │ │  (Access)   │
            └──────┬───────┘ └──────┬──────┘ └──────┬─────┘
                   │                │               │
                   └────────────────┼───────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │        Elasticsearch          │
                    │      (Log Storage)           │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │        Kibana                 │
                    │      (Log Analysis)          │
                    └───────────────────────────────┘
```
